<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>界面聚合添加剂思维导图（交互式）</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      margin: 0;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 360px;
      border-right: 1px solid #eee;
      padding: 16px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #canvas { flex: 1; position: relative; }
    h2 { margin: 6px 0 12px 0; }
    .control { margin-bottom: 12px; }
    select, input { width: 100%; padding: 8px; font-size: 14px; }
    .info { margin-top: 8px; font-size: 13px; color: #333; }
    .node-detail {
      margin-top: 12px;
      padding: 8px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #eee;
      line-height: 1.5;
    }
    .legend { font-size: 13px; margin-top: 8px; }
    svg { width: 100%; height: 100%; }
    .node { cursor: pointer; stroke: #fff; stroke-width: 1.2px; }
    .link { stroke: #999; stroke-opacity: 0.6; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>添加剂思维导图</h2>
    <div class="control">
      <label>按要调控的膜性能筛选：</label>
      <select id="propertySelect">
        <option value="">（全部）</option>
      </select>
    </div>
    <div class="control">
      <label>按底层逻辑筛选：</label>
      <select id="logicSelect">
        <option value="">（全部）</option>
        <option value="界面性质">调控油水界面性质</option>
        <option value="扩散速率">调控单体扩散速率与分布</option>
        <option value="反应动力学">调控聚合反应动力学</option>
        <option value="参与聚合">直接参与聚合或修饰产物结构</option>
      </select>
    </div>
    <div class="info">点击右侧节点查看详情。可在上方选择框按膜性能或底层逻辑过滤节点。</div>
    <div id="detail" class="node-detail">未选择任何添加剂。</div>
    <div class="legend"><strong>图例：</strong> 圆形=添加剂，方形=类别/机制</div>
  </div>

  <div id="canvas">
    <svg id="svg"></svg>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
  <script>
    // ==============================
    // 数据部分
    // ==============================
    const nodes = [
      {id:'共溶剂', type:'category'},
      {id:'极性有机化合物', type:'category'},
      {id:'表面活性剂', type:'category'},
      {id:'无机盐', type:'category'},
      {id:'亲水性大分子', type:'category'},
      {id:'纳米材料', type:'category'},
      {id:'甲醇/乙醇/多元醇', type:'additive', parent:'共溶剂', logic:'扩散速率', props:['水通量↑','选择性略降'], desc:'改善两相混溶性，增加单体向有机相扩散，提升水通量。'},
      {id:'DMSO', type:'additive', parent:'极性有机化合物', logic:'扩散速率', props:['水通量↑','交联度↓'], desc:'增加TMC在界面浓度、提高亲水性，降低活性层厚度。'},
      {id:'HMPA', type:'additive', parent:'极性有机化合物', logic:'扩散速率', props:['水通量↑','交联度↑'], desc:'与胺形成离子对，促进胺向有机相扩散，形成高交联层。'},
      {id:'TBP/TPP', type:'additive', parent:'极性有机化合物', logic:'界面性质', props:['水通量↑','选择性保持'], desc:'与TMC发生偶极相互作用/形成复合物，调节界面反应。'},
      {id:'SDS/CTAB/HTAC/TritonX', type:'additive', parent:'表面活性剂', logic:'界面性质', props:['水通量↑/↓（浓度依赖）','选择性变化'], desc:'降低界面张力，润湿膜孔，低浓度增通量，高浓度破坏致密性。'},
      {id:'NaCl/LiCl/CaCl2', type:'additive', parent:'无机盐', logic:'界面性质', props:['水通量↑','微结构变化'], desc:'调节离子强度/界面张力，影响单体分布并可促使TMC水解。'},
      {id:'NaHCO3/NH4HCO3', type:'additive', parent:'无机盐', logic:'反应动力学', props:['水通量↑','疏松PA层'], desc:'中和生成CO2，消耗HCl，形成较松散的PA层，提高通量。'},
      {id:'PVA/PEG/PVP', type:'additive', parent:'亲水性大分子', logic:'扩散速率', props:['水通量↑','薄层/表面结构变化','抗污染↑'], desc:'增大水相黏度并与胺形成氢键，抑制胺扩散，能生成Turing结构或改变厚度。'},
      {id:'单宁酸 (TA)', type:'additive', parent:'极性有机化合物', logic:'反应动力学', props:['水通量↑','交联度↑','选择性↑'], desc:'通过质子化与氢键抑制PIP扩散，形成致密且亲水的界面层。'},
      {id:'甘油', type:'additive', parent:'极性有机化合物', logic:'扩散速率', props:['薄PA层','水通量↑'], desc:'提高水相黏度，抑制PIP扩散，减薄界面层。'},
      {id:'多巴胺/氨基酸/精氨酸', type:'additive', parent:'极性有机化合物', logic:'参与聚合', props:['亲水性↑','抗污染↑','选择性可变'], desc:'含胺基/邻苯二酚，可与TMC反应或形成配合物，改变PA结构。'},
      {id:'SiO2/TiO2/Ag/沸石/GO/MOFs', type:'additive', parent:'纳米材料', logic:'参与聚合', props:['水通量↑','耐氯性/通道效应'], desc:'形成TFN嵌入界面层，提供快速传输通道或改变扩散与交联。'},
      {id:'CNTs/N-GOQD/SGO', type:'additive', parent:'纳米材料', logic:'扩散速率', props:['水通量↑','亲水性↑','部分选择性变化'], desc:'吸附单体、稳定聚合物网络或提供亲水通道，提高通量、耐氯性等。'}
    ];

    const links = nodes.filter(n => n.type === 'additive').map(n => ({ source: n.parent, target: n.id }));

    // ==============================
    // 初始化界面元素
    // ==============================
    const propSelect = document.getElementById('propertySelect');
    const allProps = new Set();
    nodes.forEach(n => n.props && n.props.forEach(p => allProps.add(p)));
    Array.from(allProps).sort().forEach(p => {
      const opt = document.createElement('option');
      opt.value = p; opt.textContent = p;
      propSelect.appendChild(opt);
    });

    // ==============================
    // 绘图
    // ==============================
    const width = document.getElementById('canvas').clientWidth;
    const height = window.innerHeight;
    const svg = d3.select('#svg').attr('viewBox', `0 0 ${width} ${height}`);

    const simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d => d.id).distance(100))
      .force('charge', d3.forceManyBody().strength(-350))
      .force('center', d3.forceCenter(width/2, height/2))
      .force('collide', d3.forceCollide().radius(d => d.type === 'category' ? 40 : 24))
      .on('tick', ticked);

    const link = svg.append('g')
      .attr('stroke', '#999')
      .attr('stroke-opacity', 0.6)
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('class', 'link');

    const node = svg.append('g')
      .selectAll('g')
      .data(nodes)
      .join('g')
      .call(drag(simulation));

    node.append('circle')
      .attr('r', d => d.type === 'category' ? 28 : 14)
      .attr('fill', d => {
        if (d.type === 'category') return '#2b8cbe';
        if (d.logic === '界面性质') return '#7b3294';
        if (d.logic === '扩散速率') return '#a1d99b';
        if (d.logic === '反应动力学') return '#fdae61';
        if (d.logic === '参与聚合') return '#e34a33';
        return '#ccc';
      })
      .attr('class', 'node')
      .on('click', showDetail)
      .on('mouseover', function() { d3.select(this).attr('stroke', '#000'); })
      .on('mouseout', function() { d3.select(this).attr('stroke', '#fff'); });

    node.append('text')
      .attr('x', 12)
      .attr('y', 4)
      .text(d => d.id)
      .style('font-size', '12px');

    function ticked() {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
      node.attr('transform', d => `translate(${d.x},${d.y})`);
    }

    function drag(sim) {
      return d3.drag()
        .on('start', (event, d) => {
          if (!event.active) sim.alphaTarget(0.3).restart();
          d.fx = d.x; d.fy = d.y;
        })
        .on('drag', (event, d) => {
          d.fx = event.x; d.fy = event.y;
        })
        .on('end', (event, d) => {
          if (!event.active) sim.alphaTarget(0);
          d.fx = null; d.fy = null;
        });
    }

    // ==============================
    // 交互逻辑
    // ==============================
    function showDetail(e, d) {
      const el = document.getElementById('detail');
      if (d.type === 'category') {
        el.innerHTML = `<strong>类别：</strong>${d.id}<br>点击具体添加剂查看详细信息。`;
      } else {
        el.innerHTML = `
          <strong>${d.id}</strong><br>
          <em>底层逻辑：</em>${d.logic}<br>
          <em>作用/机理：</em>${d.desc}<br>
          <em>影响的膜性能：</em>${d.props.join(', ')}<br><br>
          <small>数据来源：整理自综述文献（示例）。</small>`;
      }
    }

    propSelect.addEventListener('change', applyFilters);
    document.getElementById('logicSelect').addEventListener('change', applyFilters);

    function applyFilters() {
      const p = propSelect.value;
      const lg = document.getElementById('logicSelect').value;
      node.style('opacity', nd => {
        if (nd.type === 'category') return 0.6;
        if (p && (!nd.props || !nd.props.includes(p))) return 0.15;
        if (lg && nd.logic !== lg) return 0.15;
        return 1;
      });
    }

    window.addEventListener('resize', () => {
      const w = document.getElementById('canvas').clientWidth;
      const h = window.innerHeight;
      svg.attr('viewBox', `0 0 ${w} ${h}`);
      simulation.force('center', d3.forceCenter(w/2, h/2));
      simulation.alpha(0.3).restart();
    });
  </script>
</body>
</html>